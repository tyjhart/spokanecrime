---
title: "Spokane Weekly Watch"
author: "Tyler Hart"
date: "2020-03-03"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
classoption: landscape
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
- \floatplacement{figure}{H}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(stringr)
library(data.table)
library(scales)
library(lunar)
library(kableExtra)
library(magick)
library(webshot)
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  results = 'asis',
  fig.align = 'center',
  fig.pos = 'ht',
  dpi = 400,
  fig.path='./figures/',
  dev=c('svg','png'),
  out.width = '100%'
  )
library(kableExtra)

source("./summer_dates.R") # Dates for start / end of summer
source("./text_import.R") # Build crime data frame
source("./categorize_offenses.R") # Categorize offense names
source("./lunar_seasons.R") # Lunar phase, seasons

# Plot data source note
data_source_str <- "SOURCE: Spokane Police Department CompStat"

# Alpha for geom_point plotting
point_alpha = 0.25

# Abbrev. offense names
levels(df.crimes$category)[levels(df.crimes$category)=="THEFT OF MOTOR VEHICLE"] <- "VEH. THEFT"
levels(df.crimes$category)[levels(df.crimes$category)=="TAKING MOTOR VEHICLE"] <- "TAKING VEH."
levels(df.crimes$category)[levels(df.crimes$category)=="VEHICLE PROWLING"] <- "VEH. PROWL"
levels(df.crimes$category)[levels(df.crimes$category)=="DRIVE BY SHOOTING"] <- "DRIVE-BY"
levels(df.crimes$category)[levels(df.crimes$category)=="VEHICLE TRESPASS"] <- "VEH. TRESPASS"
levels(df.crimes$category)[levels(df.crimes$category)=="HARASSMENT"] <- "HARASS."

# Moon phase abbreviations
levels(df.crimes$lunar_phase)[levels(df.crimes$lunar_phase)=="Waning gibbous"] <- "Waning Gibb."
levels(df.crimes$lunar_phase)[levels(df.crimes$lunar_phase)=="Waning crescent"] <- "Waning Cres."
levels(df.crimes$lunar_phase)[levels(df.crimes$lunar_phase)=="Waxing crescent"] <- "Waxing Cres."
levels(df.crimes$lunar_phase)[levels(df.crimes$lunar_phase)=="Waxing gibbous"] <- "Waxing Gibb."

# Summarized daily offenses
daily_offenses <- df.crimes %>%
  group_by(date) %>%
  summarize(offenses = n())
```

```{r plot.offenses_over_time, fig.cap = "Offenses Over Time, September 12, 2017 Onward"}
daily_offenses %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_hline(yintercept=0, linetype=4) +
  labs(
    x = "", 
    y = "Offenses", 
    title = "Total Offenses", 
    caption = data_source_str
    )
```

```{r plot.offenses_over_time_pred, fig.cap = "Offenses Over Time, September 12, 2017 Onward"}
daily_offenses %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red", fullrange = TRUE) +
  scale_x_date(limits = as.Date(c("2017-10-01","2021-01-01")), date_breaks = "1 year", date_labels = "%Y") +
  labs(
    x = "", 
    y = "Offenses", 
    title = "Total Offenses", 
    subtitle = "Projection of Average Daily Offenses",
    caption = paste(data_source_str, "Projection CI 0.95", sep = "\n")
    )
```

```{r plot.monthly_offense_comparisons, fig.cap = "Monthly Offenses, 2018 Onward"}
df.crimes %>%
group_by(year,num.month) %>%
summarize(offenses = n()) %>%
ggplot(aes(num.month, offenses, color = year)) +
geom_point(size = 3, alpha = 0.5) +
labs(
  x = "Month",
  y = "Offenses",
  title = "Monthly Offenses",
  color = "Year",
  caption = "
  NOTE: Current month's data may be incomplete
  SOURCE: Spokane Police Department CompStat
  "
  ) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r plot.weekly_offense_comparisons, fig.cap = "Weekly Offenses, 2018 Onward"}
df.crimes %>%
  filter(date >= "2017-09-12") %>%
group_by(year,num.week) %>%
summarize(offenses = n()) %>%
ggplot(aes(num.week, offenses, color = year)) +
geom_point(size = 3, alpha = 0.5) +
labs(
  x = "Week",
  y = "Offenses",
  title = "Weekly Offenses",
  color = "Year",
  caption = data_source_str
  ) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


```{r plot.theft_over_time, fig.cap = "Thefts"}
df.crimes %>%
  filter(category == "THEFT") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Thefts", 
    title = "Overall Thefts", 
    caption = data_source_str
    ) 
```



```{r plot.shoplifting_over_time, fig.cap = "Shoplifting"}
df.crimes %>%
  filter(subcategory == "Shoplifting") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) +
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Shoplifting Thefts", 
    title = "Shoplifting Thefts", 
    caption = data_source_str
    )
```

```{r plot.firearm_thefts, fig.cap = "Firearm Thefts"}
df.crimes %>%
  filter(category %in% c("THEFT") & subcategory %in% c("Firearm")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Firearm Thefts", 
    title = "Firearm Thefts", 
    caption = data_source_str
    )
```

```{r plot.burglaries_over_time, fig.cap = "Burglaries"}
df.crimes %>%
  filter(category %in% c("BURGLARY")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Burglaries", 
    title = "Overall Burglaries", 
    caption = data_source_str
    ) 
```

```{r plot.residential_burglaries, fig.cap = "Residential Burglaries"}
df.crimes %>%
  filter(category %in% c("BURGLARY") & subcategory %in% c("Residential")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Residential Burglaries", 
    title = "Residential Burglaries", 
    caption = data_source_str
    )
```

```{r plot.commercial_burglaries, fig.cap = "Commercial Burglaries"}
df.crimes %>%
  filter(category %in% c("BURGLARY") & subcategory %in% c("Commercial")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Commercial Burglaries", 
    title = "Commercial Burglaries", 
    caption = data_source_str
    )
```

```{r plot.shoplifting_thefts, fig.cap = "Shoplifting"}
df.crimes %>%
  filter(category %in% c("THEFT") & subcategory %in% c("Shoplifting")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Shoplifting", 
    title = "Shoplifting Thefts", 
    caption = data_source_str
    )
```

```{r plot.tomv_over_time, fig.cap = "Theft of Motor Vehicles"}
df.crimes %>%
  filter(category %in% c("VEH. THEFT")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Vehicle Thefts", 
    title = "Vehicle Thefts", 
    caption = data_source_str
    )
```

```{r plot.assault_over_time, fig.cap = "Assaults"}
df.crimes %>%
  filter(category %in% c("ASSAULT")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Assaults", 
    title = "Assaults", 
    caption = data_source_str
    )
```

```{r plot.rape_over_time, fig.cap = "Sexual Assaults"}
df.crimes %>%
  filter(category %in% c("RAPE")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = point_alpha) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b-%Y") +
  labs(
    x = "", 
    y = "Sexual Assaults", 
    title = "Sexual Assaults", 
    caption = data_source_str
    ) 
```

```{r plot.ytd_offenses_by_district, fig.cap = "Offenses by Police District, YTD"}
df.crimes %>%
  filter(year == 2020) %>%
  count(district) %>%
  ggplot(aes(reorder(district, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  labs(
    x = "Police Districts", 
    title = "Offenses by Police District", 
    subtitle = "2020 YTD",
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.total_offenses_by_district, fig.cap = "Offenses by Police District"}
df.crimes %>%
  filter(!district %in% c("SPA","SPB","SPC","SPD")) %>%
  count(district) %>%
  ggplot(aes(reorder(district, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  labs(
    x = "Police Districts", 
    title = "Offenses by Police District",
    subtitle = "2017 - 2020",
    caption = "
    NOTE: Excluding districts SPA, SPB, SPC, SPD
    SOURCE: Spokane Police Department CompStat
    "
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.ytd_offenses_by_type, fig.cap = "Types of Offenses, 2019 YTD"}
df.crimes %>%
  filter(year == 2020) %>%
  count(category) %>%
  ggplot(aes(reorder(category, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  labs(
    x = "Police Districts", 
    title = "Types of Offenses", 
    subtitle = "2020 YTD",
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.total_offenses_by_type, fig.cap = "Types of Offenses"}
df.crimes %>%
  count(category) %>%
  ggplot(aes(reorder(category, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  labs(
    x = "Police Districts", 
    title = "Types of Offenses", 
    subtitle = "2017 - 2020",
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.2019_offenses_by_weekday, fig.cap = "Offenses by Day, 2019 YTD"}
df.crimes %>%
  filter(year == 2019) %>%
  count(dow) %>%
  ggplot(aes(fct_relevel(dow,"Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  labs(
    x = "Days", 
    title = "Offenses by Day", 
    subtitle = "2019",
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.ytd_offenses_by_weekday, fig.cap = "Offenses by Day, 2019 YTD"}
df.crimes %>%
  filter(year == 2020) %>%
  count(dow) %>%
  ggplot(aes(fct_relevel(dow,"Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  labs(
    x = "Days", 
    title = "Offenses by Day", 
    subtitle = "2020 YTD",
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.offenses_by_lunar_phase, fig.cap = "Offenses by Lunar Phase"}
df.crimes %>%
  count(lunar_phase) %>%
  ggplot(aes(fct_relevel(lunar_phase,"Full","Waning Gibb.","Last quarter","Waning Cres.","New","Waxing Cres.","First quarter","Waxing Gibb."), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  labs(
    x = "Lunar Phases", 
    title = "Offenses by Lunar Phase", 
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```

```{r plot.violent_offenses_by_lunar_phase, fig.cap = "Violent Offenses by Lunar Phase"}
df.crimes %>%
  filter(category %in% c("ASSAULT", "MURDER", "RAPE", "ROBBERY")) %>%
  count(lunar_phase) %>%
  ggplot(aes(fct_relevel(lunar_phase,"Full","Waning Gibb.","Last quarter","Waning Cres.","New","Waxing Cres.","First quarter","Waxing Gibb."), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  labs(
    x = "Lunar Phase", 
    title = "Violent Offenses by Lunar Phase", 
    caption = data_source_str
    ) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1))
```
---
title: "Testing"
author: "Tyler Hart"
date: "4/13/2019"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup}
library(readtext)
library(tidyverse)
library(stringi)
library(data.table)
library(doParallel)
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  fig.pos = 'h',
  fig.align = 'center',
  collapse = TRUE,
  results = 'asis',
  dpi = 400,
  fig.path='./figures/',
  dev=c('pdf', 'png')
  )

# Multi-core
cl <- makePSOCKcluster(4)
registerDoParallel(cl)

source("./offense_dict.R") # Offense types, categories
source("./summer_dates.R") # Dates for start / end of summer
source("./new_crimes.R") # Build crime data frame
# source("./old_crime_data.R") # Old data from 2013, 2014, and 2015
# source("./vehicle_offense.R") # Check for vehicle-related offenses
# source("./normalize_offenses.R") # True-up offenses
# source("./factorize.R") # Factorize offenses, districts
# source("./plot_data.R") # Build data frames for plotting

stopCluster(cl)
```

```{r plot.total_offenses_over_time, fig.cap = "Total Offenses Over Time", fig.align = 'center', dev='png', fig.width = 10, fig.height = 7.5}
df.crimes %>%
  filter(date >= "2017-09-12") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point() +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("Date") +
  ylab("Daily Offenses") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Total Crime by Day")
```

```{r}
df.crimes %>%
  filter(date >= "2017-09-12") %>%
  count(district) %>%
  ggplot(aes(reorder(district, -n),n)) +
  geom_bar(stat = "identity")
```

```{r}
df.district_summary <- df.crimes %>%
  filter(date >= "2017-09-12") %>%
  group_by(district) %>%
  summarize(dist_sum = n())

df.district_summary$percentage <- round(df.district_summary$dist_sum / sum(df.district_summary$dist_sum), 3) * 100

kable(
  df.district_summary[
    order(-df.district_summary$dist_sum),
    ], caption = "Police District Crime Values"
  )
```

```{r plot.total_crimes_by_district}
# Plot all offenses by district
# total.crimes_district %>% 
#   ggplot(aes(reorder(district, -total), total)) + 
#   geom_col() +
#   geom_hline(yintercept=mean(total.crimes_district$total), linetype = 4) +
#   xlab("Police District") +
#   ylab("Total Offenses") +
#   ggtitle("All Offenses by District")
# 
# # Plot total vehicle-relation crimes by district
# total.auto_district %>% 
#   ggplot(aes(reorder(district, -motor_vehicle_involved), motor_vehicle_involved)) + 
#   geom_col() +
#   geom_hline(yintercept=mean(total.auto_district$motor_vehicle_involved), linetype = 4) +
#   xlab("Police District") +
#   ylab("Total Auto-Involved Offenses") +
#   ggtitle("Auto-Involved Offenses by District")
```

```{r plot.total_offenses_by_type}
# total.offense_types %>%
#   ggplot(aes(reorder(offense, -total), total)) +
#   geom_col() + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   xlab("Offenses") +
#   ylab("Total") +
#   ggtitle("Total Offenses by Type")
```
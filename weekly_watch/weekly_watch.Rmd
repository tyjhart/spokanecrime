---
title: "Spokane Weekly Watch"
author: "Tyler Hart"
date: "5/18/2019"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
  word_document:
    toc: yes
    toc_depth: '2'
  html_document:
    df_print: paged
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
- \floatplacement{figure}{H}
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(readtext)
library(tidyverse)
library(stringi)
library(data.table)
library(doParallel)
library(scales)
library(kableExtra)
library(magick)
library(webshot)
library(knitr)
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  results = 'asis',
  fig.align = 'center',
  fig.pos = 'ht',
  dpi = 400,
  fig.path='./figures/',
  dev=c('svg','png'),
  out.width = '100%'
  )
library(kableExtra)

# Multi-core
cl <- makePSOCKcluster(4)
registerDoParallel(cl)

source("./summer_dates.R") # Dates for start / end of summer
source("./csv_import.R") # Build crime data frame
source("./old_crime_data.R") # Old data from 2013, 2014, and 2015
```

```{r plot.offenses_over_time, fig.cap = "Offenses Over Time, September 12, 2017 Onward"}
df.crimes %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  ylab("Total Offenses") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("CompStat Total Offenses, September 12, 2017 Onward")
```

```{r plot.theft_over_time, fig.cap = "Thefts"}
df.crimes %>%
  filter(category == "Theft") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  ylab("Thefts") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("CompStat Thefts, September 12, 2017 Onward")
```

```{r plot.shoplifting_over_time, fig.cap = "Shoplifting"}
df.crimes %>%
  filter(category == "Shoplifting") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  ylab("Shoplifting") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("CompStat Shoplifting, September 12, 2017 Onward")
```

```{r plot.burglaries_over_time, fig.cap = "Burglaries"}
df.crimes %>%
  filter(category %in% c("Burglary", "Residential Burglary", "Commercial Burglary")) %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  ylab("Burglaries") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("CompStat Overall Burglaries, September 12, 2017 Onward")
```

```{r plot.tomv_over_time, fig.cap = "Theft of Motor Vehicles"}
df.crimes %>%
  filter(category == "Theft of Motor Vehicle") %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  scale_y_continuous("Motor Vehicle Thefts", labels = comma) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("CompStat Theft of Motor Vehicles, September 12, 2017 Onward")
```

```{r plot.2019_offenses_by_district, fig.cap = "Offenses by Police District, 2019 YTD"}
df.crimes %>%
  filter(date >= "2019-01-01") %>%
  count(district) %>%
  ggplot(aes(reorder(district, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1)) +
  xlab("Police Districts") +
  ggtitle("Offenses by Police District, 2019 YTD")
```

```{r plot.total_offenses_by_district, fig.cap = "Offenses by Police District"}
df.crimes %>%
  count(district) %>%
  ggplot(aes(reorder(district, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  scale_y_continuous("Offenses", labels = comma, expand = c(.1, .1)) +
  xlab("Police Districts") +
  ggtitle("Offenses by Police District, September 12, 2017 Onward")
```

```{r table.district_stats}
# District statistics
df.district_summary <- df.crimes %>%
  filter(date >= "2019-01-01") %>%
  group_by(district) %>%
  summarize(dist_sum = n())

df.district_summary$percentage <- round(df.district_summary$dist_sum / sum(df.district_summary$dist_sum), 3) * 100

kable(df.district_summary[order(-df.district_summary$dist_sum),], col.names = c("Police District", "Offenses", "Percentage"), caption = "Statistics by District, 2019 YTD") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.district_stats_ytd.png")

df.district_summary <- df.crimes %>%
  group_by(district) %>%
  summarize(dist_sum = n())

df.district_summary$percentage <- round(df.district_summary$dist_sum / sum(df.district_summary$dist_sum), 3) * 100

kable(df.district_summary[order(-df.district_summary$dist_sum),], col.names = c("Police District", "Offenses", "Percentage"), caption = "Statistics by District, September 12, 2017 Onward") %>%
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.district_stats_total.png")
```

```{r plot.offenses_by_type_ytd, fig.cap = "Types of Offenses, 2019 YTD"}
df.crimes %>%
  filter(date >= "2019-01-01") %>%
  count(category) %>%
  ggplot(aes(reorder(category, -n), n, label = n)) +
  geom_col() +
  geom_text(vjust = -0.5) +
  scale_y_continuous(expand = c(.1, .1)) +
  xlab("Category") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  xlab("") +
  ylab("Offenses") +
  ggtitle("Types of Offenses, 2019 YTD")
```

```{r plot.total_offenses_by_type, fig.cap = "Types of Offenses"}
df.crimes %>%
  count(category) %>%
  ggplot(aes(reorder(category, -n), n, label = n)) +
  geom_col() +
  geom_text(angle = 90, vjust = 0.2, hjust = -0.2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust=1)) +
  xlab("") +
  scale_y_continuous("Offenses", limits = c(0, 8000)) +
  ggtitle("Types of Offenses, September 12, 2017 Onward")
```

```{r table.offense_summaries}
# All Offenses
df.monthly_summary <- df.crimes %>% 
  group_by(year, num.month) %>%
  summarize(total.offenses = n())

kable(spread(df.monthly_summary, key = year, value = total.offenses), col.names = c("Month", 2017, 2018, 2019), caption = "Total Offenses") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.offenses.png") 

# Thefts
df.monthly_summary <- df.crimes %>% 
  filter(category %in% c("Shoplifting", "Theft")) %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Total Thefts") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.thefts.png") 

# All Burglaries
df.monthly_summary <- df.crimes %>%
  filter(category %in% c("Residential Burglary", "Commercial Burglary", "Garage Burglary", "Fenced Area Burglary")) %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "All Burglaries") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.burglaries.png") 
```

```{r table.shoplifting}
df.monthly_summary <- df.crimes %>% 
  filter(category == "Shoplifting") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Shoplifting") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.shoplifting.png") 
```

```{r table.mail_theft}
# Mail Theft
df.monthly_summary <- df.crimes %>% 
  filter(category == "Mail Theft") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Mail Theft") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.mail_theft.png") 
```

```{r table.motor_veh_theft}
# Motor Vehicle Theft
df.monthly_summary <- df.crimes %>% 
  filter(category == "Theft of Motor Vehicle") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Motor Vehicle Thefts") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.motor_vehicle_theft.png") 
```

```{r table.residential_burglary}
# Residential Burglaries
df.monthly_summary <- df.crimes %>%
  filter(category %in% c("Residential Burglary")) %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Residential Burglaries") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.residential_burglary.png") 
```

```{r table.commercial_burglary}
# Commercial Burglaries
df.monthly_summary <- df.crimes %>%
  filter(category %in% c("Commercial Burglary")) %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Commercial Burglaries") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.commercial_burglary.png") 
```

```{r table.other_burglary}
# Fenced Area & Garage Burglaries
df.monthly_summary <- df.crimes %>%
  filter(category %in% c("Garage Burglary", "Fenced Area Burglary")) %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Fenced Area and Garage Burglaries") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.other_burglary.png") 
```

```{r table.robbery}
# Robbery
df.monthly_summary <- df.crimes %>% 
  filter(category == "Robbery") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Robberies") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.robberies.png") 
```

```{r table.assault}
# Assault
df.burglary_monthly_summary <- df.crimes %>% 
  filter(category == "Assault") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.burglary_monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Assaults") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.assaults.png") 
```

```{r table.rape}
# Rape
df.burglary_monthly_summary <- df.crimes %>% 
  filter(category == "Rape") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.burglary_monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Sexual Assaults (Rape)") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.rapes.png") 
```

```{r table.intimidate_weapon}
# Intimidate with Weapon
df.burglary_monthly_summary <- df.crimes %>% 
  filter(category == "Intimidate With Weapon") %>%
  group_by(year, num.month) %>%
  summarize(total.thefts = n())

kable(spread(df.burglary_monthly_summary, key = year, value = total.thefts), col.names = c("Month", 2017, 2018, 2019), caption = "Intimidation with Weapon") %>% 
  kable_styling(bootstrap_options = c("condensed", "striped"), full_width=FALSE, font_size=12) %>%
  as_image(file = "figures/table.intimidation_weapon.png") 
```

```{r plot.2013_2016_offenses, fig.cap = "Offenses Over Time, 2013-2016"}
df.old_crime %>%
  group_by(date) %>%
  summarize(offenses = n()) %>%
  ggplot(aes(date, offenses)) + 
  geom_point(size = 3, alpha = 0.5) +
  geom_smooth(method = "auto", color = "blue") +
  geom_smooth(method = "lm", color = "red") +
  geom_vline(xintercept=c(summer_dates$summer_start, summer_dates$summer_end), linetype=4) +
  xlab("") +
  ylab("Daily Offenses") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Legacy Offense Data, 2013-2016")
```

```{r stop_cluster}
stopCluster(cl)
```